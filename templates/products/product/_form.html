{% load humanize %}
{% load currency %}

<form
    hx-post="{% if product %}{% url 'product:edit' product.pk %}{% else %}{% url 'product:create' %}{% endif %}"
    hx-encoding="multipart/form-data"
    id="product-form"
    class="space-y-1">
    {% csrf_token %}
    {% if product %}
    <input type="hidden" name="brand_id" value="{{ product.brand.id }}">
    {% elif current_brand %}
    <input type="hidden" name="brand_id" value="{{ current_brand.id }}">
    {% endif %}

    <div class="container mx-auto px-3 py-1">
        <!-- Error Messages -->
        <div id="form-errors" class="hidden mb-2">
            <div class="bg-red-50 border border-red-200 text-red-800 px-3 py-2 rounded-lg text-xs">
                <i class="fas fa-exclamation-circle mr-1"></i>
                <span id="error-message"></span>
            </div>
        </div>
        <!-- Header -->
        <div class="flex justify-between items-center mb-1">
            <div>
                <h1 class="text-lg font-bold text-gray-800">
                    {% if product %}Edit Product New - TEST{% else %}Add Product{% endif %}
                </h1>
                <p class="text-xs text-gray-600">
                    {% if product %}Update product information{% else %}Create new product{% endif %}
                </p>
            </div>
            <div class="flex gap-1.5">
                <a href="{% url 'product:list' %}"
                   class="px-2.5 py-1.5 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors text-xs">
                    ‚Üê Back to Products
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-1.5">
            <!-- Image Upload -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-lg shadow p-2">
                    <h3 class="text-xs font-semibold text-gray-800 mb-1.5">Product Image</h3>

                    <!-- Current Image -->
                    <div class="mb-1.5" id="image-preview-container">
                        <div id="image-preview" class="w-full">
                            {% if product.photos.all %}
                                {% for photo in product.photos.all %}
                                    {% if photo.is_primary %}
                                    <img src="{{ photo.image_url|safe }}" alt="{{ product.name }}"
                                         class="w-full rounded-lg shadow-md mb-0.5"
                                         onerror="console.error('Failed to load image:', this.src); this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                    <div class="w-full h-32 bg-gray-200 rounded-lg items-center justify-center mb-0.5" style="display: none;">
                                        <div class="text-center text-gray-400">
                                            <svg class="w-12 h-12 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                            </svg>
                                            <p class="text-xs">Image Load Failed</p>
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            {% elif product and product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}"
                                 class="w-full rounded-lg shadow-md mb-0.5">
                            {% else %}
                            <div class="w-full h-32 bg-gray-200 rounded-lg flex items-center justify-center mb-0.5">
                                <div class="text-center text-gray-400">
                                    <svg class="w-12 h-12 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                                    </svg>
                                    <p class="text-xs">No Image</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Upload Button -->
                    <label class="block w-full px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white text-center rounded-lg cursor-pointer transition text-xs">
                        üì§ Upload
                        <input type="file" name="images" accept="image/*" class="hidden" onchange="previewImage(event)">
                    </label>
                    <p class="text-xs text-gray-500 mt-0.5">Max 5MB</p>
                </div>

                <!-- Status -->
                <div class="bg-white rounded-lg shadow p-2 mt-1.5">
                    <h3 class="text-xs font-semibold text-gray-800 mb-1.5">Status</h3>
                    <div class="space-y-1.5">
                        <label class="flex items-center">
                            <input type="checkbox" name="is_active" {% if product.is_active or not product %}checked{% endif %}
                                   class="w-4 h-4 text-green-600 border-gray-300 rounded focus:ring-green-500">
                            <span class="ml-2 text-xs text-gray-700">Product is Active</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="track_stock" {% if product and product.track_stock %}checked{% endif %}
                                   class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                            <span class="ml-2 text-xs text-gray-700">Track Stock Quantity</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Product Details Form -->
            <div class="lg:col-span-2 space-y-1.5">
                <!-- Basic Information -->
                <div class="bg-white rounded-lg shadow p-2">
                    <h3 class="text-xs font-semibold text-gray-800 mb-1.5 border-b pb-1">Basic Information</h3>
                    <div class="grid grid-cols-2 gap-1.5">
                        <div class="col-span-2">
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Product Name *</label>
                            <input type="text" name="name" value="{{ product.name|default:'' }}" required
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">PLU Product *</label>
                            <input type="text" name="sku" value="{{ product.sku|default:'' }}" required
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Category *</label>
                            <select name="category_id" required
                                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono">
                                <option value="">Select Category</option>
                                {% for cat in category_tree %}
                                    {% if cat.parent %}
                                    <option value="{{ cat.id }}" 
                                            {% if product and product.category.id == cat.id %}selected{% endif %}
                                            class="font-normal">
                                        &nbsp;&nbsp;‚îî‚îÄ {{ cat.name }}
                                    </option>
                                    {% else %}
                                    <option value="" disabled class="font-semibold text-gray-700" style="background: #f3f4f6;">
                                        {{ cat.name }}
                                    </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                            <p class="mt-0.5 text-xs text-gray-500">Select subcategory under parent group</p>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Menu Category</label>
                            <input type="text" name="description" value="{{ product.description|default:'' }}"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                   placeholder="e.g., Hot Coffee, Ice Coffee, Cold Beverage">
                            <p class="mt-0.5 text-xs text-gray-500">Sub-category for grouping similar products</p>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="bg-white rounded-lg shadow p-2">
                    <h3 class="text-xs font-semibold text-gray-800 mb-1.5 border-b pb-1">Pricing</h3>
                    <div class="grid grid-cols-2 gap-1.5">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Selling Price (Rp) *</label>
                            <input type="text" name="price" value="{{ product.price|comma_number }}" required
                                   inputmode="numeric" autocomplete="off"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent money-input">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Cost Price (Rp)</label>
                            <input type="text" name="cost" value="{{ product.cost|comma_number }}"
                                   inputmode="numeric" autocomplete="off"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent money-input">
                        </div>
                    </div>
                </div>

                <!-- Stock & Printer -->
                <div class="bg-white rounded-lg shadow p-2">
                    <h3 class="text-xs font-semibold text-gray-800 mb-1.5 border-b pb-1">Stock & Printer Settings</h3>
                    <div class="grid grid-cols-3 gap-1.5">
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Stock Quantity</label>
                            <input type="number" name="stock_quantity" value="{{ product.stock_quantity|default:0 }}" min="0"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Low Stock Alert</label>
                            <input type="number" name="low_stock_alert" value="{{ product.low_stock_alert|default:10 }}" min="0"
                                   class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-700 mb-0.5">Printer Target</label>
                            <select name="printer_target"
                                    class="w-full px-2 py-1 text-xs border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="kitchen" {% if product and product.printer_target == 'kitchen' %}selected{% endif %}>Kitchen</option>
                                <option value="bar" {% if product and product.printer_target == 'bar' %}selected{% endif %}>Bar</option>
                                <option value="dessert" {% if product and product.printer_target == 'dessert' %}selected{% endif %}>Dessert</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Condiments / Modifiers Assignment -->
                <div class="bg-white rounded-lg shadow p-2" x-data="{ showAssignModal: false, activeTab: 0 }">
                    <div class="flex items-center justify-between mb-1.5 border-b pb-1">
                        <h3 class="text-xs font-semibold text-gray-800">Condiments / Modifiers</h3>
                        {% if product %}
                        <button type="button" 
                                @click="showAssignModal = true"
                                hx-get="{% url 'product:modifier-assign' product.pk %}"
                                hx-target="#assign-modal-content"
                                class="px-2 py-1 text-xs bg-purple-600 text-white rounded hover:bg-purple-700 transition">
                            <i class="fas fa-edit mr-1"></i>Assign Modifiers
                        </button>
                        {% endif %}
                    </div>

                    {% if product and product.product_modifiers.all %}
                    <div class="flex gap-1 mb-2 overflow-x-auto pb-1 border-b">
                        {% for product_modifier in product.product_modifiers.all %}
                        <button type="button"
                                @click="activeTab = {{ forloop.counter0 }}"
                                :class="activeTab === {{ forloop.counter0 }} ? 'bg-purple-600 text-white border-purple-600' : 'bg-white text-gray-700 border-gray-300 hover:border-purple-300'"
                                class="px-3 py-1.5 border rounded-lg font-medium text-xs transition whitespace-nowrap flex-shrink-0">
                            {{ product_modifier.modifier.name }}
                            <span class="ml-1 text-[10px] opacity-75">
                                ({% if product_modifier.modifier.is_required %}Required{% else %}Optional{% endif %})
                            </span>
                        </button>
                        {% endfor %}
                    </div>

                    {% for product_modifier in product.product_modifiers.all %}
                    <div x-show="activeTab === {{ forloop.counter0 }}" class="space-y-1.5">
                        {% for option in product_modifier.modifier.options.all %}
                        <div class="flex items-center justify-between bg-white p-2 rounded border border-gray-200">
                            <span class="text-xs text-gray-700 font-medium">{{ option.name }}</span>
                            <span class="font-semibold text-xs {% if option.price_adjustment > 0 %}text-green-600{% elif option.price_adjustment < 0 %}text-red-600{% else %}text-gray-600{% endif %}">
                                {% if option.price_adjustment > 0 %}
                                +Rp {{ option.price_adjustment|floatformat:0 }}
                                {% elif option.price_adjustment < 0 %}
                                Rp {{ option.price_adjustment|floatformat:0 }}
                                {% else %}
                                Free
                                {% endif %}
                            </span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="bg-gray-50 rounded-lg p-3 text-center">
                        <svg class="w-8 h-8 mx-auto mb-1 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        <p class="text-xs text-gray-600 font-medium mb-1">No Modifiers Assigned</p>
                        <p class="text-xs text-gray-400">Click "Assign Modifiers" to add</p>
                    </div>
                    {% endif %}

                    <!-- Assign Modal -->
                    <div x-show="showAssignModal" 
                         x-cloak
                         @keydown.escape.window="showAssignModal = false"
                         class="fixed inset-0 z-50 overflow-y-auto" 
                         style="display: none;">
                        <div class="flex items-center justify-center min-h-screen px-4">
                            <div x-show="showAssignModal"
                                 @click="showAssignModal = false"
                                 x-transition:enter="ease-out duration-300"
                                 x-transition:enter-start="opacity-0"
                                 x-transition:enter-end="opacity-100"
                                 class="fixed inset-0 bg-gray-500 bg-opacity-75"></div>

                            <div x-show="showAssignModal"
                                 x-transition:enter="ease-out duration-300"
                                 x-transition:enter-start="opacity-0 scale-95"
                                 x-transition:enter-end="opacity-100 scale-100"
                                 class="relative bg-white rounded-lg shadow-xl max-w-2xl w-full">
                                
                                <div class="bg-purple-600 px-4 py-3 rounded-t-lg">
                                    <div class="flex items-center justify-between">
                                        <h3 class="text-base font-semibold text-white">Assign Modifiers</h3>
                                        <button @click="showAssignModal = false" class="text-white hover:text-gray-200">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>

                                <div id="assign-modal-content" class="p-4">
                                    <div class="flex justify-center items-center py-8">
                                        <i class="fas fa-spinner fa-spin text-2xl text-purple-600"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="bg-white rounded-lg shadow p-2">
                    <div class="flex justify-end gap-1.5">
                        <button type="button"
                            class="px-2.5 py-1.5 text-xs bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition font-medium"
                            @click="showModal = false">
                            Cancel
                        </button>
                        <button type="submit"
                                class="px-2.5 py-1.5 text-xs bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center font-medium">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                            </svg>
                            {% if product %}Save Changes{% else %}Create Product{% endif %}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<script>
function previewImage(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('image-preview');
            preview.innerHTML = '<img src="' + e.target.result + '" class="w-full rounded-lg shadow-md">';
        };
        reader.readAsDataURL(file);
    }
}

function formatMoneyInput(input) {
    const raw = input.value.replace(/[^0-9]/g, '');
    input.value = raw ? Number(raw).toLocaleString('en-US') : '';
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.money-input').forEach((input) => {
        formatMoneyInput(input);
        input.addEventListener('input', () => formatMoneyInput(input));
    });
});
</script>

<script>
console.log('üîß Product form script loaded');

// Listen at document level for HTMX events (form loaded dynamically)
document.body.addEventListener('htmx:beforeRequest', function(evt) {
    const form = evt.detail.elt;
    if (form.id !== 'product-form') return;
    
    console.log('üöÄ === PRODUCT FORM SUBMIT ===');
    console.log('URL:', form.getAttribute('hx-post'));
    
    // Log all form fields
    const formData = new FormData(form);
    console.log('üìã Form Fields:');
    for (let [key, value] of formData.entries()) {
        if (value instanceof File) {
            console.log(`  ${key}: [File] ${value.name} (${value.size} bytes)`);
        } else {
            console.log(`  ${key}: "${value}"`);
        }
    }
});

document.body.addEventListener('htmx:afterRequest', function(evt) {
    const form = evt.detail.elt;
    if (form.id !== 'product-form') return;
    
    const status = evt.detail.xhr.status;
    console.log('üì® === RESPONSE RECEIVED ===');
    console.log('Status:', status);
    
    if (status >= 400) {
        console.error('‚ùå === ERROR DETAILS ===');
        console.error('Status Code:', status);
        console.error('Response Text:', evt.detail.xhr.responseText);
        
        try {
            const jsonResponse = JSON.parse(evt.detail.xhr.responseText);
            console.error('üìÑ Parsed JSON:', jsonResponse);
        } catch (e) {
            console.error('‚ö†Ô∏è Response is not JSON - showing raw HTML/text');
        }
    } else {
        console.log('‚úÖ Success:', evt.detail.xhr.responseText.substring(0, 100));
    }
});

document.body.addEventListener('htmx:responseError', function(evt) {
    const form = evt.detail.elt;
    if (form.id !== 'product-form') return;
    
    console.error('üí• === HTMX RESPONSE ERROR ===');
    console.error('Status:', evt.detail.xhr.status);
    console.error('Response:', evt.detail.xhr.responseText);
    
    let message = 'Save failed. Please check required fields.';
    try {
        const data = JSON.parse(evt.detail.xhr.responseText);
        console.error('Error data:', data);
        if (data && data.message) message = data.message;
    } catch (e) {
        console.error('Could not parse error response');
    }

    const errorBox = document.getElementById('form-errors');
    const errorMessage = document.getElementById('error-message');
    if (errorBox && errorMessage) {
        errorMessage.textContent = message;
        errorBox.classList.remove('hidden');
    }
});
</script>

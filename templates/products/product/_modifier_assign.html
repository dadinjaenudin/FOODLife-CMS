{% load static %}
<form hx-post="{% url 'product:modifier-assign' product.pk %}"
      hx-swap="none"
      class="space-y-3">
    {% csrf_token %}
    
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
        <div class="flex items-center gap-2">
            <i class="fas fa-info-circle text-blue-600"></i>
            <div>
                <p class="text-sm font-semibold text-blue-900">{{ product.name }}</p>
                <p class="text-xs text-blue-600">Select modifiers to assign to this product</p>
            </div>
        </div>
    </div>
    
    {% if modifiers %}
    <div class="space-y-2 max-h-96 overflow-y-auto">
        {% for modifier in modifiers %}
        <label class="flex items-start p-3 bg-white border rounded-lg hover:bg-gray-50 cursor-pointer transition">
            <input type="checkbox" 
                   name="modifier_ids" 
                   value="{{ modifier.id }}"
                   {% if modifier.id in assigned_modifier_ids %}checked{% endif %}
                   class="w-4 h-4 text-purple-600 rounded focus:ring-purple-500 mt-0.5">
            <div class="ml-3 flex-1">
                <div class="flex items-center justify-between">
                    <span class="text-sm font-medium text-gray-900">{{ modifier.name }}</span>
                    <span class="text-xs px-2 py-0.5 rounded {% if modifier.is_required %}bg-red-100 text-red-700{% else %}bg-gray-100 text-gray-600{% endif %}">
                        {% if modifier.is_required %}Required{% else %}Optional{% endif %}
                    </span>
                </div>
                <div class="mt-1 text-xs text-gray-500">
                    <span class="mr-3">
                        <i class="fas fa-list mr-1"></i>{{ modifier.options.count }} options
                    </span>
                    <span>
                        <i class="fas fa-check-double mr-1"></i>Max: {{ modifier.max_selections|default:"unlimited" }}
                    </span>
                </div>
                {% if modifier.options.all %}
                <div class="mt-2 flex flex-wrap gap-1">
                    {% for option in modifier.options.all|slice:":5" %}
                    <span class="text-xs px-2 py-0.5 bg-purple-50 text-purple-700 rounded">
                        {{ option.name }}
                        {% if option.price_adjustment != 0 %}
                        <span class="font-semibold">
                            {% if option.price_adjustment > 0 %}+{% endif %}{{ option.price_adjustment|floatformat:0 }}
                        </span>
                        {% endif %}
                    </span>
                    {% endfor %}
                    {% if modifier.options.count > 5 %}
                    <span class="text-xs px-2 py-0.5 bg-gray-100 text-gray-600 rounded">
                        +{{ modifier.options.count|add:"-5" }} more
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </label>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
        <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mb-2"></i>
        <p class="text-sm text-yellow-800 font-medium">No Modifiers Available</p>
        <p class="text-xs text-yellow-600 mt-1">Create modifiers first in Master Data â†’ Modifiers</p>
    </div>
    {% endif %}
    
    <div class="flex justify-end gap-2 pt-3 border-t">
        <button type="button"
                @click="showAssignModal = false"
                class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
            Cancel
        </button>
        {% if modifiers %}
        <button type="submit"
                class="px-3 py-1.5 text-sm bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
            <i class="fas fa-save mr-1"></i>Save Assignment
        </button>
        {% endif %}
    </div>
</form>

<script>
document.body.addEventListener('htmx:afterRequest', function(evt) {
    const form = evt.target;
    if (form.getAttribute('hx-post') && form.getAttribute('hx-post').includes('modifier-assign')) {
        const xhr = evt.detail.xhr;
        if (xhr.status === 200) {
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success) {
                    showToast(data.message || 'Modifiers assigned successfully', 'success');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showToast(data.message || 'Failed to assign modifiers', 'error');
                }
            } catch (e) {
                showToast('Error processing response', 'error');
            }
        }
    }
});
</script>

{% extends 'base.html' %}

{% load humanize %}

{% block content %}
<div class="min-h-screen bg-gray-100 py-6">
    <div class="max-w-6xl mx-auto px-4">
        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">
                    {% if product %}Edit Product{% else %}Add New Product{% endif %}
                </h1>
                <p class="text-gray-600 text-sm mt-1">
                    {% if product %}Update product details and inventory{% else %}Create a new product in {{ current_brand.name }}{% endif %}
                </p>
            </div>
            <a href="{% url 'product:list' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium">
                <i class="fas fa-arrow-left mr-2"></i>Back to Products
            </a>
        </div>

        <!-- Main Form -->
        <form method="POST" enctype="multipart/form-data" class="bg-white rounded-lg shadow-sm border">
            {% csrf_token %}

            <!-- Error Messages -->
            {% if form.non_field_errors %}
            <div class="bg-red-50 border-b border-red-200 px-6 py-4">
                <p class="text-red-800 text-sm font-medium mb-2">Please fix the following errors:</p>
                {% for error in form.non_field_errors %}
                <p class="text-red-700 text-sm">• {{ error }}</p>
                {% endfor %}
            </div>
            {% endif %}

            <div class="grid grid-cols-12 gap-8 p-6">
                <!-- LEFT COLUMN: Image & Status (3 cols) -->
                <div class="col-span-12 md:col-span-4 space-y-6">
                    
                    <!-- Product Image -->
                    <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                        <div class="aspect-square bg-gray-100 flex items-center justify-center relative group">
                            {% if product.primary_photo %}
                                {% if product.primary_photo.get_image_url %}
                                    <img src="{{ product.primary_photo.get_image_url }}" 
                                         alt="{{ product.name }}" 
                                         class="w-full h-full object-cover"
                                         id="previewImage">
                                {% elif product.primary_photo.photo %}
                                    <img src="{{ product.primary_photo.photo.url }}" 
                                         alt="{{ product.name }}" 
                                         class="w-full h-full object-cover"
                                         id="previewImage">
                                {% endif %}
                            {% else %}
                                <div class="text-center" id="placeholderImage">
                                    <i class="fas fa-image text-gray-300 text-4xl mb-2 block"></i>
                                    <p class="text-gray-400 text-sm">No Image</p>
                                    <p class="text-gray-400 text-xs mt-1">Click below to upload</p>
                                </div>
                            {% endif %}
                            
                            <!-- Hover overlay -->
                            <div class="absolute inset-0 bg-black/30 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                                <label class="cursor-pointer bg-white px-3 py-2 rounded-lg text-sm font-medium text-gray-700">
                                    <i class="fas fa-upload mr-2"></i>Change Image
                                    <input type="file" name="images" accept="image/*" multiple class="hidden" id="imagesInput">
                                </label>
                            </div>
                        </div>

                        <!-- Upload Instructions -->
                        <div class="p-4 border-t border-gray-200 bg-blue-50">
                            <div class="flex items-start gap-2">
                                <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                                <div class="text-xs text-blue-800">
                                    <p class="font-semibold mb-1">Image Upload to MinIO</p>
                                    <p>• First image = Primary photo</p>
                                    <p>• Multiple images supported</p>
                                    <p>• Format: JPG, PNG (max 5MB each)</p>
                                    <p class="mt-2 text-blue-600">{% if product.photos.count %}{{ product.photos.count }} image(s) uploaded{% else %}No images yet{% endif %}</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Status Section -->
                    <div class="space-y-4">
                        <div class="bg-white rounded-lg border border-gray-200 p-4">
                            <h3 class="font-semibold text-gray-900 mb-4 text-sm">Status</h3>
                            
                            <!-- Active Status -->
                            <div class="mb-3">
                                <label class="flex items-center">
                                    <input type="checkbox" name="is_active" 
                                           {% if product.is_active or not product %}checked{% endif %}
                                           class="w-4 h-4 rounded border-gray-300 text-green-600">
                                    <span class="ml-2 text-sm text-gray-700">Active Status</span>
                                </label>
                                {% if product.is_active or not product %}
                                <span class="inline-block mt-2 px-2 py-1 bg-green-100 text-green-700 text-xs rounded">✓ Active</span>
                                {% endif %}
                            </div>

                            <!-- Track Stock -->
                            <div>
                                <label class="flex items-center">
                                    <input type="checkbox" name="track_stock" 
                                           {% if product.track_stock %}checked{% endif %}
                                           class="w-4 h-4 rounded border-gray-300 text-green-600">
                                    <span class="ml-2 text-sm text-gray-700">Track Stock</span>
                                </label>
                                {% if product.track_stock %}
                                <span class="inline-block mt-2 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">✓ Yes</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COLUMN: Form Fields (9 cols) -->
                <div class="col-span-12 md:col-span-8 space-y-6">
                    
                    <!-- Basic Information -->
                    <div class="border-l-4 border-blue-500 pl-4">
                        <h3 class="font-semibold text-gray-900 mb-4 text-sm uppercase text-gray-600">Basic Information</h3>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <!-- Product Name -->
                            <div class="col-span-2">
                                <label for="name" class="block text-xs font-medium text-gray-700 mb-1">
                                    Product Name <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="name" id="name" 
                                       value="{{ product.name|default:'' }}"
                                       required
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="e.g. Fresh Espresso">
                                {% if form.name.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.name.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- SKU -->
                            <div>
                                <label for="sku" class="block text-xs font-medium text-gray-700 mb-1">
                                    SKU <span class="text-red-500">*</span>
                                </label>
                                <input type="text" name="sku" id="sku"
                                       value="{{ product.sku|default:'' }}"
                                       required
                                       {% if product %}readonly{% endif %}
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="e.g. SKU001">
                                {% if form.sku.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.sku.errors.0 }}</p>
                                {% endif %}
                            </div>

                            <!-- RLU Product (Display only) -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">RLU Product</label>
                                <input type="text" disabled
                                       value="{{ product.id|default:'(Auto-generated)' }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-gray-50 text-gray-500"
                                       placeholder="Auto-generated">
                            </div>

                            <!-- Category -->
                            <div>
                                <label for="category_id" class="block text-xs font-medium text-gray-700 mb-1">
                                    Category <span class="text-red-500">*</span>
                                </label>
                                <select name="category_id" id="category_id" required
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">Select Category</option>
                                    {% for cat in categories %}
                                    <option value="{{ cat.id }}" 
                                            {% if product.category_id == cat.id %}selected{% endif %}>
                                        {{ cat.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Additional Category -->
                            <div>
                                <label for="additional" class="block text-xs font-medium text-gray-700 mb-1">Additional</label>
                                <input type="text" name="additional" id="additional"
                                       value="{{ product.additional|default:'' }}"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                       placeholder="e.g. Caffeine Level">
                            </div>

                            <!-- Printer Target -->
                            <div>
                                <label for="printer_target" class="block text-xs font-medium text-gray-700 mb-1">Printer Target</label>
                                <select name="printer_target" id="printer_target"
                                        class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="kitchen" {% if product.printer_target == 'kitchen' %}selected{% endif %}>Kitchen</option>
                                    <option value="bar" {% if product.printer_target == 'bar' %}selected{% endif %}>Bar</option>
                                    <option value="counter" {% if product.printer_target == 'counter' %}selected{% endif %}>Counter</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing -->
                    <div class="border-l-4 border-green-500 pl-4">
                        <h3 class="font-semibold text-gray-900 mb-4 text-sm uppercase text-gray-600">Pricing</h3>
                        
                        <div class="grid grid-cols-3 gap-4">
                            <!-- Selling Price -->
                            <div>
                                <label for="price" class="block text-xs font-medium text-gray-700 mb-1">
                                    Selling Price <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-sm text-gray-600">Rp</span>
                                    <input type="number" name="price" id="price"
                                           value="{{ product.price|default:0 }}"
                                           required step="0.01" min="0"
                                           class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                           placeholder="27.000">
                                </div>
                            </div>

                            <!-- Cost Price -->
                            <div>
                                <label for="cost" class="block text-xs font-medium text-gray-700 mb-1">Cost Price</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-sm text-gray-600">Rp</span>
                                    <input type="number" name="cost" id="cost"
                                           value="{{ product.cost|default:0 }}"
                                           step="0.01" min="0"
                                           class="w-full pl-8 pr-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-green-500 focus:border-transparent"
                                           placeholder="0">
                                </div>
                            </div>

                            <!-- Profit Margin (Display Only) -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Profit Margin</label>
                                <input type="text" id="profit" disabled
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm bg-gray-50 text-gray-600"
                                       value="(Auto-calculated)">
                            </div>
                        </div>
                    </div>

                    <!-- Stock Information -->
                    <div class="border-l-4 border-orange-500 pl-4">
                        <h3 class="font-semibold text-gray-900 mb-4 text-sm uppercase text-gray-600">Stock Information</h3>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <!-- Current Stock -->
                            <div>
                                <label for="stock_quantity" class="block text-xs font-medium text-gray-700 mb-1">
                                    Current Stock
                                </label>
                                <input type="number" name="stock_quantity" id="stock_quantity"
                                       value="{{ product.stock_quantity|default:0 }}"
                                       step="1" min="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="1.000">
                                <p class="text-gray-500 text-xs mt-1">{{ product.stock_quantity|default:0 }} units</p>
                            </div>

                            <!-- Low Stock Alert -->
                            <div>
                                <label for="low_stock_alert" class="block text-xs font-medium text-gray-700 mb-1">Low Stock Alert</label>
                                <input type="number" name="low_stock_alert" id="low_stock_alert"
                                       value="{{ product.low_stock_alert|default:10 }}"
                                       step="1" min="0"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:border-transparent"
                                       placeholder="10">
                                <p class="text-gray-500 text-xs mt-1">10 units</p>
                            </div>
                        </div>
                    </div>

                    <!-- Modifiers/Condiments -->
                    <div class="border-l-4 border-purple-500 pl-4">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-semibold text-gray-900 text-sm uppercase text-gray-600">
                                <i class="fas fa-sliders-h mr-2"></i>Condiments / Modifiers
                            </h3>
                            <button type="button" class="text-purple-600 text-xs font-medium hover:text-purple-700">
                                + Add Modifier
                            </button>
                        </div>
                        
                        <div class="space-y-3 text-sm text-gray-600">
                            <p>No modifiers assigned yet. Click "Add Modifier" to add product condiments (Sugar Level, Ice Level, Temperature, etc.)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="border-t border-gray-200 px-6 py-4 flex items-center justify-between bg-gray-50 rounded-b-lg">
                <div class="text-xs text-gray-600">
                    {% if product %}
                    <span>Created {{ product.created_at|date:"d M Y H:i" }} | Last Updated {{ product.updated_at|date:"d M Y H:i" }}</span>
                    {% endif %}
                </div>
                
                <div class="flex gap-3">
                    <a href="{% url 'product:list' %}" class="px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50">
                        Cancel
                    </a>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                        <i class="fas fa-save mr-2"></i>
                        {% if product %}Update Product{% else %}Create Product{% endif %}
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
// Calculate profit margin - with null checks
const priceInput = document.getElementById('price');
const costInput = document.getElementById('cost');

function calculateProfit() {
    if (!priceInput || !costInput) return;
    
    const price = parseFloat(priceInput.value) || 0;
    const cost = parseFloat(costInput.value) || 0;
    const profit = price - cost;
    
    const profitInput = document.getElementById('profit');
    if (profitInput) {
        profitInput.value = profit > 0 ? `Rp ${profit.toLocaleString('id-ID')}` : '-';
    }
}

if (priceInput) priceInput.addEventListener('input', calculateProfit);
if (costInput) costInput.addEventListener('input', calculateProfit);

// Handle image upload preview (Multiple images)
const imagesInput = document.getElementById('imagesInput');
if (imagesInput) {
    imagesInput.addEventListener('change', function(e) {
        const files = e.target.files;
        if (files && files.length > 0) {
            // Show first image as preview
            const firstFile = files[0];
            const reader = new FileReader();
            reader.onload = function(event) {
                const placeholder = document.getElementById('placeholderImage');
                if (placeholder) {
                    placeholder.remove();
                }
                
                let previewImg = document.getElementById('previewImage');
                if (!previewImg) {
                    previewImg = document.createElement('img');
                    previewImg.id = 'previewImage';
                    previewImg.className = 'w-full h-full object-cover';
                    const aspectSquare = document.querySelector('.aspect-square');
                    if (aspectSquare) {
                        aspectSquare.prepend(previewImg);
                    }
                }
                if (previewImg) {
                    previewImg.src = event.target.result;
                }
            };
            reader.readAsDataURL(firstFile);
            
            // Show selected count
            console.log(`${files.length} image(s) selected for upload to MinIO`);
        }
    });
}

// Initialize profit calculation
calculateProfit();
</script>
{% endblock %}
